<%@ page contentType="text/html" pageEncoding="UTF-8"%>
<%@ page import="bbh.domain.Usuario"%>
<%@ page import="bbh.domain.util.UsuarioTipo"%>
<%@ page import="bbh.domain.Local"%>
<%@ page import="java.util.List"%>

<%@ include file="../includes/header.jsp" %>

<section class="welcome-section">
    <%
        Usuario usuario = (Usuario) session.getAttribute("usuarioLogado");
        if (usuario == null) {
            usuario = (Usuario) session.getAttribute("usuario");
        }
        String nomeUsuario = (usuario != null && usuario.getNome() != null) ? usuario.getNome() : "Visitante";
        boolean isEstab = (usuario != null && usuario.getUsuarioTipo() == UsuarioTipo.ESTABELECIMENTO);
    %>

    <h1>Bem vindo, <%= nomeUsuario %></h1>
    <h2 class="subtitle">Venha explorar Belo Horizonte conosco</h2>

    <div class="search-bar">
        <% if (isEstab) { %>
            <form action="<%= request.getContextPath() %>/pesquisarLocais" method="get">
                <input type="text" name="nome" placeholder="Digite o nome do estabelecimento, ponto tur√≠stico ou evento"
                       value="<%= request.getAttribute("nomeBusca") != null ? request.getAttribute("nomeBusca") : "" %>">
                <button type="submit">üîç</button>
            </form>
        <% } else { %>
            <p style="text-align:center;color:#444;">
                <% if (usuario == null) { %>
                    Voc√™ precisa <a href="<%= request.getContextPath() %>/login.jsp">entrar</a> para usar a pesquisa.
                <% } else { %>
                    A aba de pesquisa est√° dispon√≠vel apenas para usu√°rios do tipo <strong>ESTABELECIMENTO</strong>.
                <% } %>
            </p>
        <% } %>
    </div>
</section>


<%-- exemplo de renderiza√ß√£o de resultados em outra section (n√£o fa√ßa l√≥gica de busca aqui) --%>
<section class="resultados-section">
    <%
        List<Local> resultados = (List<Local>) request.getAttribute("resultados");
        String erro = (String) request.getAttribute("erro");
        String nomeBusca = (String) request.getAttribute("nomeBusca");
    %>

    <% if (erro != null) { %>
        <p style="color:red;text-align:center;"><%= erro %></p>
    <% } %>

    <% if (isEstab) {
         if (resultados != null && !resultados.isEmpty()) { %>
             <div class="card-grid">
                 <% for (Local l : resultados) { %>
                     <a class="card" href="<%= request.getContextPath() %>/detalheLocal?cnpj=<%= l.getCnpj() %>">
                         <img src="<%= l.getImagemUrl() != null ? l.getImagemUrl() : '../imgs/restaurante.jpeg' %>" alt="imagem">
                         <div>
                             <p style="margin:0;font-weight:700;"><%= l.getNome() %></p>
                             <small style="color:#666;"><%= l.getCategoria() %> ‚Ä¢ <%= l.getEndereco() %></small>
                         </div>
                     </a>
                 <% } %>
             </div>
         <% } else if (nomeBusca != null) { %>
             <p style="text-align:center;">Nenhum local encontrado para "<%= nomeBusca %>".</p>
         <% }
    } %>
</section>
